<div class="gantt-table-header">
  <div class="gantt-table-column" *ngFor="let column of columnList; let i = index" [style.width]="column.columnWidth">
    <ng-container *ngIf="column.headerTemplateRef; else default" [ngTemplateOutlet]="column.headerTemplateRef"></ng-container>
    <ng-template #default>
      {{ column.name }}
    </ng-template>
    <div
      class="column-resize-handle"
      cdkDrag
      cdkDragLockAxis="x"
      cdkDragBoundary=".gantt"
      (cdkDragStarted)="onResizeStarted($event)"
      (cdkDragMoved)="onResizeMoved($event, column)"
      (cdkDragEnded)="onResizeEnded($event, column)"
    ></div>
  </div>
</div>
<div class="gantt-table-body">
  <ng-container *ngIf="!groups.length && !items.length">
    <ng-container *ngIf="!emptyTemplate">
      <gantt-icon class="empty-icon" iconName="empty"></gantt-icon>
      <div class="empty-text">没有数据</div>
    </ng-container>
    <ng-template [ngTemplateOutlet]="emptyTemplate"></ng-template>
  </ng-container>

  <ng-container *ngIf="groups && groups.length > 0; else itemsTemplate">
    <ng-container *ngFor="let group of groups; trackBy: trackBy">
      <div class="gantt-table-group" [ngClass]="group.class">
        <div class="gantt-table-group-title" [class.expanded]="group.expanded" (click)="expandGroup(group)">
          <gantt-icon class="expand-icon" [iconName]="group.expanded ? 'angle-down' : 'angle-right'"></gantt-icon>
          <ng-container *ngIf="groupTemplate; else default">
            <ng-template
              [ngTemplateOutlet]="groupTemplate"
              [ngTemplateOutletContext]="{ $implicit: group.origin, group: group.origin }"
            ></ng-template>
          </ng-container>
          <ng-template #default>
            <span class="group-title">{{ group.title }}</span>
          </ng-template>
        </div>
      </div>

      <ng-container *ngIf="group.expanded">
        <ng-template
          [ngTemplateOutlet]="ganttItems"
          [ngTemplateOutletContext]="{ group: group, items: group.items, level: 0, parentId: group.id }"
        ></ng-template>
      </ng-container>
    </ng-container>
  </ng-container>
</div>
<div
  class="table-resize-trigger"
  cdkDrag
  cdkDragLockAxis="x"
  cdkDragBoundary=".gantt"
  (cdkDragStarted)="onResizeStarted($event)"
  (cdkDragMoved)="onResizeMoved($event)"
  (cdkDragEnded)="onOverallResizeEnded($event)"
></div>
<div #resizeLine class="table-resize-line"></div>

<ng-template #itemsTemplate let-parentId="parentId">
  <div cdkDropListGroup>
    <ng-template [ngTemplateOutlet]="ganttItems" [ngTemplateOutletContext]="{ items: items, level: 0, parentId: parentId }"></ng-template>
  </div>
</ng-template>

<ng-template #ganttItems let-group="group" let-items="items" let-parentId="parentId" let-level="level">
  <div
    [id]="parentId"
    cdkDropList
    [cdkDropListAutoScrollStep]="6"
    [cdkDropListData]="items"
    [cdkDropListSortingDisabled]="true"
    (cdkDropListDropped)="onListDropped($event)"
  >
    <ng-container *ngFor="let item of items; trackBy: trackBy">
      <div
        cdkDrag
        [cdkDragData]="item"
        [cdkDragDisabled]="(draggable && item.itemDraggable === false) || !draggable"
        (cdkDragStarted)="onItemDragStarted($event)"
        (cdkDragEnded)="onItemDragEnded($event)"
        (cdkDragMoved)="emitItemDragMoved($event)"
        (click)="itemClick.emit({ event: $event, selectedValue: this.item.origin })"
        class="gantt-table-item"
        [class.gantt-table-item-first-level-group]="level === 0 && (item.type | isGanttRangeItem)"
        [class.gantt-table-item-with-group]="group"
        [class.gantt-table-item-active]="ganttUpper.isSelected(item.id)"
        [style.height.px]="gantt.styles.lineHeight"
        [style.lineHeight.px]="gantt.styles.lineHeight"
      >
        <ng-template
          [ngTemplateOutlet]="rowBeforeTemplate"
          [ngTemplateOutletContext]="{ $implicit: item.origin, item: item.origin }"
        ></ng-template>
        <div class="gantt-table-column" *ngFor="let column of columnList; let first = first" [style.width]="column.columnWidth">
          <!-- drag icon -->
          <gantt-icon
            *ngIf="first"
            class="gantt-drag-handle"
            iconName="drag"
            cdkDragHandle
            [cdkDragHandleDisabled]="(draggable && item.itemDraggable === false) || !draggable"
          ></gantt-icon>
          <!-- expand icon -->
          <div *ngIf="column?.showExpandIcon || (!hasExpandIcon && first)" class="gantt-expand-icon" [style.marginLeft.px]="level * 20">
            <ng-container *ngIf="level < gantt.maxLevel - 1 && item.expandable">
              <gantt-icon
                *ngIf="!item.loading"
                class="expand-icon"
                [iconName]="item.expanded ? 'angle-down' : 'angle-right'"
                (click)="expandChildren($event, item)"
              ></gantt-icon>
              <gantt-icon *ngIf="item.loading" [iconName]="'loading'"></gantt-icon>
            </ng-container>
          </div>
          <!-- column content -->
          <div class="gantt-table-column-content">
            <ng-template
              [ngTemplateOutlet]="column.templateRef"
              [ngTemplateOutletContext]="{ $implicit: item.origin, item: item.origin }"
            ></ng-template>
          </div>
        </div>
        <ng-template
          [ngTemplateOutlet]="rowAfterTemplate"
          [ngTemplateOutletContext]="{ $implicit: item.origin, item: item.origin }"
        ></ng-template>
      </div>
      <ng-template
        *ngIf="item.children && item.expanded"
        [ngTemplateOutlet]="ganttItems"
        [ngTemplateOutletContext]="{ items: item.children, level: level + 1, group: group, parentId: item.id }"
      ></ng-template>
    </ng-container>
  </div>
</ng-template>
